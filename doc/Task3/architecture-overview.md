# Task 3: Enhanced Role-Based Access Control System - Architecture Overview

## Описание задачи

Task 3 реализует улучшенную систему контроля доступа на основе ролей (RBAC) для VersityGW S3 Gateway. Система обеспечивает детальное управление разрешениями с поддержкой иерархии ролей, агрегации разрешений и интеграции с существующей системой аутентификации.

## Архитектурные принципы

### 1. Принцип "Запретить по умолчанию" (Deny by Default)
- Все действия запрещены по умолчанию
- Явные разрешения (Allow) предоставляют доступ
- Явные запреты (Deny) имеют приоритет над разрешениями

### 2. Агрегация разрешений с семантикой объединения
- Пользователь получает объединение всех разрешений от всех назначенных ролей
- Поддержка множественных ролей для одного пользователя
- Иерархия ролей с наследованием разрешений

### 3. Обратная совместимость
- Интеграция с существующей системой контроля доступа
- Fallback к традиционным методам при недоступности улучшенных ролей
- Сохранение существующих API и интерфейсов

## Ключевые компоненты

### 1. Access Control Engine
**Файл**: `auth/access-control.go`

**Основные функции**:
- `VerifyAccess()` - модифицированная функция проверки доступа
- `verifyEnhancedRoleAccessWithAggregation()` - агрегация разрешений
- `buildResourceARN()` - построение ARN для ресурсов S3

**Ключевые изменения**:
```go
// Интеграция с улучшенными ролями
if opts.RoleManager != nil {
    allowed, err := verifyEnhancedRoleAccessWithAggregation(
        opts.RoleManager, opts.Acc.Access, opts.Bucket, opts.Object, opts.Action)
    // ...
}
```

### 2. Role Manager
**Файлы**: `auth/enhanced_role_manager.go`

**Реализации**:
- `InMemoryRoleManager` - для разработки и тестирования
- `FileBasedRoleManager` - с персистентным хранением

**Ключевые интерфейсы**:
```go
type RoleManager interface {
    CreateRole(role *EnhancedRole) error
    UpdateRole(roleID string, updates *RoleUpdates) error
    DeleteRole(roleID string) error
    AssignRole(userID, roleID, assignedBy string) error
    RevokeRole(userID, roleID string) error
    GetUserRoles(userID string) ([]*EnhancedRole, error)
    GetEffectivePermissions(userID string) (*EffectivePermissions, error)
    CheckPermission(userID, resource, action string) (bool, error)
}
```

**Модели данных**:
```go
type EnhancedRole struct {
    ID          string
    Name        string
    Description string
    Permissions []DetailedPermission
    ParentRoles []string
    CreatedAt   time.Time
    UpdatedAt   time.Time
}

type DetailedPermission struct {
    Resource   string
    Action     string
    Effect     PermissionEffect
    Conditions map[string]interface{}
}

type EffectivePermissions struct {
    UserID      string
    Permissions []DetailedPermission
    ComputedAt  time.Time
}
```

### 3. Permission Aggregation Engine
**Назначение**: Агрегация разрешений от множественных ролей с union семантикой

**Ключевые особенности**:
- Union семантика - объединение разрешений от всех ролей
- Поддержка иерархии ролей с наследованием
- Deny override - запрещающие разрешения имеют приоритет
- Эффективное вычисление итоговых разрешений

**Алгоритм агрегации**:
1. Получение всех ролей пользователя
2. Расширение иерархии ролей (включая parent roles)
3. Сбор всех разрешений от всех ролей
4. Применение union семантики для Allow разрешений
5. Применение Deny override для запрещающих разрешений
6. Возврат итогового набора эффективных разрешений

### 4. ARN Pattern Matcher
**Назначение**: Сопоставление AWS S3 ARN паттернов с ресурсами

**Поддерживаемые паттерны**:
- `arn:aws:s3:::*` - любой bucket
- `arn:aws:s3:::*/*` - любой объект в любом bucket
- `arn:aws:s3:::bucket-name` - конкретный bucket
- `arn:aws:s3:::bucket-name/*` - любой объект в конкретном bucket
- `arn:aws:s3:::bucket-name/prefix/*` - объекты с определенным префиксом

**Функциональность**:
```go
func matchesARNPattern(pattern, resource string) bool {
    // Реализация сопоставления ARN паттернов
    // Поддержка wildcards и специальных S3 паттернов
}
```

**Ключевые операции**:
- Управление ролями (CRUD)
- Назначение ролей пользователям
- Вычисление эффективных разрешений
- Поддержка иерархии ролей

### 3. Permission Engine
**Файл**: `auth/enhanced_roles.go`

**Основные структуры**:
- `EnhancedRole` - роль с детальными разрешениями
- `DetailedPermission` - гранулярное разрешение с условиями
- `PermissionSet` - агрегированные разрешения
- `RoleAssignment` - назначение роли пользователю

**Поддержка AWS ARN паттернов**:
```go
// Поддерживаемые паттерны
"arn:aws:s3:::*"        // Любой bucket
"arn:aws:s3:::*/*"      // Любой объект в любом bucket
"arn:aws:s3:::bucket/*" // Любой объект в конкретном bucket
```

### 4. Enhanced Cache
**Интеграция с существующей системой кэширования**

**Возможности**:
- LRU кэширование ролей и разрешений
- Настраиваемый TTL для разных типов данных
- Инвалидация кэша при изменениях
- Fallback механизм

## Поток выполнения

### 1. Проверка доступа
1. Пользователь отправляет S3 запрос
2. Middleware перехватывает запрос
3. `VerifyAccess()` проверяет базовые условия (root, admin, public bucket)
4. При наличии RoleManager выполняется улучшенная проверка:
   - Получение эффективных разрешений пользователя
   - Построение ARN ресурса
   - Сопоставление разрешений с запрошенным действием
5. Fallback к традиционной проверке при необходимости

### 2. Агрегация разрешений
1. Получение всех ролей пользователя
2. Расширение иерархии ролей (включение родительских ролей)
3. Сбор всех разрешен��й из всех ролей
4. Разрешение конфликтов (deny wins)
5. Создание итогового PermissionSet

### 3. Сопоставление паттернов
1. Построение ARN ресурса: `arn:aws:s3:::bucket/object`
2. Сопоставление с паттернами разрешений
3. Поддержка wildcards и специальных S3 паттернов
4. Возврат результата (allow/deny)

## Тестирование

### Реализованные тесты
1. **TestVerifyAccessWithEnhancedRoles** - основная функциональность
2. **TestPermissionAggregationFromMultipleRoles** - агрегация разрешений
3. **TestEnhancedAccessCheckerIntegration** - интеграционные тесты
4. **TestComplexRoleHierarchyAccess** - иерархия ролей
5. **TestFallbackToTraditionalAccessControl** - fallback механизм
6. **TestAccessControlErrorHandling** - обработка ошибок

### Покрытие тестами
- 9 основных тестовых сценариев
- Более 50 индивидуальных тест-кейсов
- Покрытие всех ключевых функций
- Тестирование edge cases и error handling

## Производительность и масштабируемость

### Оптимизации
- Кэширование эффективных разрешений
- Lazy loading ролей и разрешений
- Эффективное сопоставление паттернов
- Минимизация блокировок (RWMutex)

### Масштабируемость
- Поддержка горизонтального масштабирования через FileBasedRoleManager
- Возможность интеграции с внешними системами управления ролями
- Кэширование для снижения нагрузки на хранилище

## Безопасность

### Принципы безопасности
- Deny by default
- Принцип наименьших привилегий
- Валидация всех входных данных
- Аудит всех операций с ролями

### Защита от атак
- Валидация ARN паттернов
- Проверка циклических зависимостей в иерархии ролей
- Ограничение времени жизни назначений ролей
- Логирование всех операций доступа

## Интеграция

### Существующие системы
- Полная интеграция с существующим middleware аутентификации
- Совместимость с традиционными ACL и bucket policies
- Поддержка существующих ролей (Admin, User)

### Внешние системы
- Возможность интеграции с внешними IAM системами
- Поддержка различных backend хранилищ
- Интеграция с системами мониторинга и аудита

## Архитектурные диаграммы

### C4 Model Диаграммы

#### 1. Context Diagram (Контекстная диаграмма)
**Файл:** `c4-context-diagram.puml`

Показывает систему в контексте внешних пользователей и систем:
- Пользователи S3 API с Enhanced RBAC
- Администраторы системы управления ролями
- Внешние системы (IAM backends, мониторинг)
- Основные взаимодействия между компонентами

#### 2. Container Diagram (Диаграмма контейнеров)
**Файл:** `c4-container-diagram.puml`

Детализирует внутреннюю структуру VersityGW с Enhanced RBAC:
- S3 API Server - основной сервер API
- Enhanced Authentication - расширенная аутентификация с RBAC
- Role Manager - управление ролями и разрешениями
- Access Control Engine - проверка доступа с агрегацией ролей
- Permission Cache - кэширование разрешений для производительности

#### 3. Component Diagram (Диаграмма компонентов)
**Файл:** `c4-component-diagram.puml`

Показывает детальную структуру Enhanced RBAC компонентов:
- Интерфейсы и их реализации
- Внутренние зависимости между компонентами
- Слой хранения данных с различными реализациями
- Политики и валидаторы RBAC

#### 4. Code Diagram (Диаграмма кода)
**Файл:** `c4-code-diagram.puml`

Представляет структуру классов и интерфейсов:
- Основные интерфейсы (RoleManager, AccessControlEngine)
- Модели данных (EnhancedRole, DetailedPermission, EffectivePermissions)
- Реализации сервисов и хранилищ
- Middleware классы и интеграционные компоненты

#### 5. Sequence Diagram (Диаграмма последовательности)
**Файл:** `sequence-diagram.puml`

Показывает поток выполнения при проверке доступа с Enhanced RBAC:
- Полный жизненный цикл проверки доступа
- Агрегация разрешений от множественных ролей
- Fallback механизмы к традиционному контролю доступа
- Обработка ошибок и исключительных ситуаций

### Дополнительные диаграммы

#### 6. Integration Diagram (Диаграмма интеграции)
**Файл:** `rbac-integration-diagram.puml`

Показывает интеграцию Enhanced RBAC с существующей системой:
- Существующие компоненты S3 Gateway
- Новые Enhanced RBAC компоненты
- Слои интеграции и совместимости
- Механизмы обратной совместимости
- Миграционные стратегии

#### 7. Deployment Diagram (Диаграмма развертывания)
**Файл:** `rbac-deployment-diagram.puml`

Описывает физическое развертывание Enhanced RBAC системы:
- Клиентская среда (S3 SDK, Admin CLI)
- Кластер S3 Gateway с Enhanced RBAC
- Persistent storage для ролей и аудита
- Внешние системы (IAM, мониторинг)
- Сетевые границы безопасности

#### 8. Security Architecture Diagram (Диаграмма архитектуры безопасности)
**Файл:** `rbac-security-architecture.puml`

Детализирует уровни безопасности Enhanced RBAC системы:
- **Слои аутентификации**: V4 подписи + Enhanced RBAC
- **Основная безопасность RBAC**: управление ролями, агрегация разрешений
- **Безопасность данных**: шифрование, хеширование, права доступа
- **Предотвращение атак**: deny by default, privilege escalation protection
- **Аудит и мониторинг**: логирование решений о доступе
- **Соответствие стандартам**: NIST RBAC, AWS IAM compatibility

## Заключение

Task 3 успешно реализует улучшенную систему контроля доступа на основе ролей с поддержкой:
- Иерархии ролей и наследования разрешений
- Агрегации разрешений от множественных ролей
- AWS ARN паттернов для ресурсов S3
- Интеграции с существующей системой аутентификации
- Комплексного тестирования и валидации

Система обеспечивает высокий уровень безопасности, производительности и масштабируемости, сохраняя при этом обратную совместимость с существующими компонентами.

Созданная архитектурная документация включает 8 диаграмм PlantUML, покрывающих все аспекты системы от высокоуровневого контекста до деталей безопасности и развертывания, что обеспечивает полное понимание архитектуры Enhanced RBAC системы.