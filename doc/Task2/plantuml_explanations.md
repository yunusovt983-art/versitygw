# –ü–æ–¥—Ä–æ–±–Ω—ã–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è PlantUML –¥–∏–∞–≥—Ä–∞–º–º Task 2

–î–∞–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è –≤—Å–µ—Ö PlantUML –¥–∏–∞–≥—Ä–∞–º–º, —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã —Å–∏—Å—Ç–µ–º—ã MFA –≤ —Ä–∞–º–∫–∞—Ö Task 2.

## üìã –°–ø–∏—Å–æ–∫ –¥–∏–∞–≥—Ä–∞–º–º

1. [C4 Context Diagram](#1-c4-context-diagram) - –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞
2. [C4 Container Diagram](#2-c4-container-diagram) - –î–∏–∞–≥—Ä–∞–º–º–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤  
3. [C4 Component Diagram](#3-c4-component-diagram) - –î–∏–∞–≥—Ä–∞–º–º–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
4. [C4 Code Diagram](#4-c4-code-diagram) - –î–∏–∞–≥—Ä–∞–º–º–∞ –∫–æ–¥–∞
5. [MFA Sequence Diagram](#5-mfa-sequence-diagram) - –î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
6. [MFA Deployment Diagram](#6-mfa-deployment-diagram) - –î–∏–∞–≥—Ä–∞–º–º–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
7. [MFA Integration Diagram](#7-mfa-integration-diagram) - –î–∏–∞–≥—Ä–∞–º–º–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
8. [MFA Security Architecture](#8-mfa-security-architecture) - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

---

## 1. C4 Context Diagram

**–§–∞–π–ª:** `c4_context_diagram.puml`

### üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–∏—Å—Ç–µ–º—É Versity S3 Gateway —Å MFA –Ω–∞ —Å–∞–º–æ–º –≤—ã—Å–æ–∫–æ–º —É—Ä–æ–≤–Ω–µ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏, –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –≤–Ω–µ—à–Ω–∏–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ —Å–∏—Å—Ç–µ–º–∞–º–∏.

### üèóÔ∏è –û—Å–Ω–æ–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã

#### –£—á–∞—Å—Ç–Ω–∏–∫–∏ (Persons):
- **S3 API User** - –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –∏–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –∏—Å–ø–æ–ª—å–∑—É—é—â–µ–µ S3 API —Å MFA
- **System Administrator** - –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä, —É–ø—Ä–∞–≤–ª—è—é—â–∏–π MFA –ø–æ–ª–∏—Ç–∏–∫–∞–º–∏

#### –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞:
- **Versity S3 Gateway** - S3-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π API gateway —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π MFA

#### –í–Ω–µ—à–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã:
- **TOTP Authenticator** - –ú–æ–±–∏–ª—å–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (Google Authenticator, Authy)
- **IAM Backend** - –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π (LDAP, Vault, Database)
- **S3 Client Applications** - AWS CLI, SDK –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- **Monitoring System** - –°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –º–µ—Ç—Ä–∏–∫ (Prometheus, ELK)

### üîÑ –ö–ª—é—á–µ–≤—ã–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç S3 –∑–∞–ø—Ä–æ—Å—ã —Å MFA —Ç–æ–∫–µ–Ω–∞–º–∏ —á–µ—Ä–µ–∑ HTTPS
- Gateway –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ—Ç —Å IAM –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –°–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç QR –∫–æ–¥—ã –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ TOTP –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∞—É–¥–∏—Ç –ª–æ–≥–∏ –∏ –º–µ—Ç—Ä–∏–∫–∏ –≤ —Å–∏—Å—Ç–µ–º—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

### üìù –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
- RFC 6238 TOTP –≤–∞–ª–∏–¥–∞—Ü–∏—è
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ backup –∫–æ–¥–æ–≤
- –ü–æ–ª–∏—Ç–∏–∫–∏ –ø—Ä–∏–Ω—É–∂–¥–µ–Ω–∏—è MFA
- –ó–∞—â–∏—Ç–∞ –æ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ –∞—É–¥–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## 2. C4 Container Diagram

**–§–∞–π–ª:** `c4_container_diagram.puml`

### üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–î–µ—Ç–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É S3 Gateway —Å–∏—Å—Ç–µ–º—ã, –ø–æ–∫–∞–∑—ã–≤–∞—è –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∏ –∏—Ö –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ.

### üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Å–ª–æ–∏

#### 1. –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–µ—Ä:
- **S3 API Server** (Go/Fiber) - –ì–ª–∞–≤–Ω—ã–π API —Å–µ—Ä–≤–µ—Ä —Å MFA –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π

#### 2. –°–ª–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:
- **Enhanced Authentication** - V4 signature –≤–∞–ª–∏–¥–∞—Ü–∏—è —Å MFA
- **MFA Middleware** - –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –ø—Ä–∏–Ω—É–∂–¥–µ–Ω–∏–µ MFA —Ç–æ–∫–µ–Ω–æ–≤

#### 3. MFA —Å–µ—Ä–≤–∏—Å—ã:
- **MFA Service** - –û—Å–Ω–æ–≤–Ω–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ MFA
- **TOTP Generator** - RFC 6238 –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è
- **QR Code Generator** - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–æ–≤ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

#### 4. –°–ª–æ–π —Ö—Ä–∞–Ω–µ–Ω–∏—è:
- **MFA Storage** - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ MFA –¥–∞–Ω–Ω—ã–µ (JSON)
- **Configuration Storage** - MFA –ø–æ–ª–∏—Ç–∏–∫–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

#### 5. –£—Ç–∏–ª–∏—Ç—ã:
- **Audit Logger** - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ MFA —Å–æ–±—ã—Ç–∏–π
- **Metrics Collector** - –°–±–æ—Ä MFA –º–µ—Ç—Ä–∏–∫

### üîÑ –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
- API Server ‚Üí Enhanced Auth ‚Üí MFA Middleware ‚Üí MFA Service
- MFA Service –∏—Å–ø–æ–ª—å–∑—É–µ—Ç TOTP Generator, QR Generator –∏ MFA Storage
- Middleware –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å Audit Logger –∏ Metrics Collector

### üìù –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
- –§–∞–π–ª–æ–≤–∞—è –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º —Å–µ–∫—Ä–µ—Ç–æ–≤
- –•–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ backup –∫–æ–¥—ã
- –ò–∑–æ–ª—è—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ê—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

---

## 3. C4 Component Diagram

**–§–∞–π–ª:** `c4_component_diagram.puml`

### üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—É—é –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É MFA Service Container, –≤–∫–ª—é—á–∞—è –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏ –∏—Ö –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è.

### üèóÔ∏è –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

#### 1. –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã —Å–µ—Ä–≤–∏—Å–æ–≤:
- **MFAService** - –ö–æ–Ω—Ç—Ä–∞–∫—Ç –æ—Å–Ω–æ–≤–Ω—ã—Ö MFA –æ–ø–µ—Ä–∞—Ü–∏–π
- **MFAStorage** - –ö–æ–Ω—Ç—Ä–∞–∫—Ç –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö

#### 2. –û—Å–Ω–æ–≤–Ω—ã–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:
- **MFAServiceImpl** - –ì–ª–∞–≤–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è MFA —Å–µ—Ä–≤–∏—Å–∞
- **TOTPGenerator** - RFC 6238 TOTP —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
- **QRCodeGenerator** - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–æ–≤
- **MFATokenValidator** - –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤

#### 3. –†–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è:
- **FileMFAStorage** - –§–∞–π–ª–æ–≤–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ MFA –¥–∞–Ω–Ω—ã—Ö
- **MemoryMFAStorage** - In-memory —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–ª—è —Ç–µ—Å—Ç–æ–≤

#### 4. –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö:
- **MFASecret** - –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ MFA
- **MFAStatus** - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **MFAConfig** - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã MFA
- **MFAUserData** - –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **MFAPolicy** - –ü–æ–ª–∏—Ç–∏–∫–∏ –ø—Ä–∏–Ω—É–∂–¥–µ–Ω–∏—è MFA

#### 5. –î–≤–∏–∂–æ–∫ –ø–æ–ª–∏—Ç–∏–∫:
- **PolicyEvaluator** - –õ–æ–≥–∏–∫–∞ –æ—Ü–µ–Ω–∫–∏ MFA –ø–æ–ª–∏—Ç–∏–∫
- **RoleChecker** - –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–æ–ª–µ–π

#### 6. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:
- **LockoutManager** - –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏
- **BackupCodeManager** - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è backup –∫–æ–¥–æ–≤
- **SecretGenerator** - –ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è

#### 7. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:
- **MFAErrorHandler** - –û–±—Ä–∞–±–æ—Ç–∫–∞ MFA –æ—à–∏–±–æ–∫
- **MFAErrorCodes** - –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–æ–¥–æ–≤ –æ—à–∏–±–æ–∫

### üîÑ –ö–ª—é—á–µ–≤—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- MFAServiceImpl —Ä–µ–∞–ª–∏–∑—É–µ—Ç MFAService –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –≤—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (TOTP, QR, Policy, Lockout, Backup)
- FileMFAStorage –∏ MemoryMFAStorage —Ä–µ–∞–ª–∏–∑—É—é—Ç MFAStorage
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–Ω–µ—à–Ω–µ–π IAM —Å–∏—Å—Ç–µ–º–æ–π —á–µ—Ä–µ–∑ RoleChecker

### üìù –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã
- Dependency Injection —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
- Single Responsibility –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
- Testability —Å –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è–º–∏ –¥–ª—è —Ç–µ—Å—Ç–æ–≤
- Security by Design —Å –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

---

## 4. C4 Code Diagram

**–§–∞–π–ª:** `c4_code_diagram.puml`

### üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–∞–º—ã–π –¥–µ—Ç–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –∫–ª–∞—Å—Å–∞–º–∏, –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞–º–∏ –∏ –∏—Ö –º–µ—Ç–æ–¥–∞–º–∏.

### üèóÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–¥–∞

#### 1. –û—Å–Ω–æ–≤–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã:
- **MFAService** - `GenerateSecret()`, `ValidateTOTP()`, `EnableMFA()`, `GetMFAStatus()`
- **MFAStorage** - `StoreMFAData()`, `GetMFAData()`, `DeleteMFAData()`

#### 2. –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö:
- **MFASecret** - `Secret`, `QRCode`, `BackupCodes`, `Issuer`, `AccountName`
- **MFAStatus** - `Enabled`, `LastUsed`, `BackupCodesRemaining`, `FailedAttempts`
- **MFAConfig** - `Required`, `TOTPWindow`, `BackupCodes`, `GracePeriod`, `MaxFailedAttempts`
- **MFAUserData** - `UserID`, `Secret`, `BackupCodes`, `Enabled`, `LockedUntil`
- **MFAPolicy** - `RequiredForRoles`, `RequiredForUsers`, `ExemptUsers`, `Active`

#### 3. –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞:
- **MFAServiceImpl** - –û—Å–Ω–æ–≤–Ω–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
- **TOTPGenerator** - RFC 6238 —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å –º–µ—Ç–æ–¥–∞–º–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- **QRCodeGenerator** - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–æ–≤ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

#### 4. –†–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è:
- **FileMFAStorage** - JSON —Ñ–∞–π–ª–æ–≤–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å –∞—Ç–æ–º–∞—Ä–Ω—ã–º–∏ –∑–∞–ø–∏—Å—è–º–∏ –∏ –ø—Ä–∞–≤–∞–º–∏ 0600
- **MemoryMFAStorage** - In-memory —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ —Ç–µ—Å—Ç–æ–≤

#### 5. Middleware –∫–ª–∞—Å—Å—ã:
- **MFAMiddleware** - `VerifyMFA()`, `RequireMFA()`, `extractMFAToken()`
- **EnhancedAuthMiddleware** - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è V4 signature + MFA –≤–∞–ª–∏–¥–∞—Ü–∏—è
- **MFATokenValidator** - –£—Ç–∏–ª–∏—Ç—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤

#### 6. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:
- **BackupCodeManager** - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è, —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è backup –∫–æ–¥–æ–≤
- **LockoutManager** - –õ–æ–≥–∏–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **SecretGenerator** - –ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–µ–∫—Ä–µ—Ç–æ–≤

#### 7. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:
- **MFAError** - `Code`, `Message`, `UserID`
- **MFAErrorCode** - `InvalidToken`, `UserLocked`, `NotEnabled`

#### 8. –£—Ç–∏–ª–∏—Ç—ã:
- **ContextKeys** - `MFAVerified`, `Account`, `IsRoot`
- **AuditLogger** - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ MFA —Å–æ–±—ã—Ç–∏–π
- **MetricsCollector** - –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫ —É—Å–ø–µ—Ö–∞/–Ω–µ—É–¥–∞—á–∏

### üîÑ –î–µ—Ç–∞–ª—å–Ω—ã–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
- –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –º–µ—Ç–æ–¥–∞–º–∏
- –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —É—Ç–∏–ª–∏—Ç–∞–º–∏ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –º–µ—Ç—Ä–∏–∫

### üìù –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏
- **RFC 6238 Features:** 30-—Å–µ–∫—É–Ω–¥–Ω—ã–µ –æ–∫–Ω–∞, HMAC-SHA1, 6-–∑–Ω–∞—á–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã, Base32 –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ
- **Security Features:** –ê—Ç–æ–º–∞—Ä–Ω—ã–µ —Ñ–∞–π–ª–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ 0600, JSON —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è
- **Key Methods:** –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –º–µ—Ç–æ–¥–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–ª–∞—Å—Å–∞

---

## 5. MFA Sequence Diagram

**–§–∞–π–ª:** `mfa_sequence_diagram.puml`

### üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–ª–Ω—ã–π –∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª MFA —Å–∏—Å—Ç–µ–º—ã —á–µ—Ä–µ–∑ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π.

### üèóÔ∏è –£—á–∞—Å—Ç–Ω–∏–∫–∏ –¥–∏–∞–≥—Ä–∞–º–º—ã
- **S3 User** - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å S3 API
- **S3 Client** - –ö–ª–∏–µ–Ω—Ç—Å–∫–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
- **S3 Gateway** - –û—Å–Ω–æ–≤–Ω–æ–π —à–ª—é–∑
- **Enhanced Auth** - –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
- **MFA Middleware** - MFA middleware
- **MFA Service** - MFA —Å–µ—Ä–≤–∏—Å
- **TOTP Generator** - TOTP –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä
- **MFA Storage** - MFA —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
- **TOTP App** - TOTP –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
- **Audit Logger** - –ê—É–¥–∏—Ç –ª–æ–≥–≥–µ—Ä

### üîÑ –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

#### 1. MFA Setup Phase (–ù–∞—Å—Ç—Ä–æ–π–∫–∞ MFA):
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫—É MFA
2. Gateway –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ V4 –ø–æ–¥–ø–∏—Å—å
3. MFA Service –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–µ–∫—Ä–µ—Ç –∏ backup –∫–æ–¥—ã
4. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è QR –∫–æ–¥ –∏ backup –∫–æ–¥—ã
5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫–∞–Ω–∏—Ä—É–µ—Ç QR –∫–æ–¥ –≤ TOTP –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
6. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å TOTP —Ç–æ–∫–µ–Ω–æ–º
7. –ê–∫—Ç–∏–≤–∞—Ü–∏—è MFA –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

#### 2. MFA Authentication Phase (–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è MFA):
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç TOTP —Ç–æ–∫–µ–Ω –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
2. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç S3 –∑–∞–ø—Ä–æ—Å —Å MFA —Ç–æ–∫–µ–Ω–æ–º –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
3. Gateway –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç V4 –ø–æ–¥–ø–∏—Å—å –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è MFA
4. MFA Middleware –∏–∑–≤–ª–µ–∫–∞–µ—Ç –∏ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç MFA —Ç–æ–∫–µ–Ω
5. –ü—Ä–∏ —É—Å–ø–µ—Ö–µ - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞, –ø—Ä–∏ –Ω–µ—É–¥–∞—á–µ - –æ—à–∏–±–∫–∞

#### 3. Backup Code Usage (–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ backup –∫–æ–¥–æ–≤):
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å —Å backup –∫–æ–¥–æ–º
2. TOTP –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç
3. –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–±—É–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏—é backup –∫–æ–¥–∞
4. –ü—Ä–∏ —É—Å–ø–µ—Ö–µ - –∫–æ–¥ —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö
5. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º –æ–± –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ backup –∫–æ–¥–∞

#### 4. Error Handling (–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫):
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π/–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω
2. –°–∏—Å—Ç–µ–º–∞ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É–µ—Ç —Å—á–µ—Ç—á–∏–∫ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
3. –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ - –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
4. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
5. –í–æ–∑–≤—Ä–∞—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π –æ—à–∏–±–∫–∏ –∫–ª–∏–µ–Ω—Ç—É

### üìù –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- –í—Ä–µ–º–µ–Ω–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤ (30-—Å–µ–∫—É–Ω–¥–Ω—ã–µ –æ–∫–Ω–∞)
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- Backup –∫–æ–¥—ã –¥–ª—è —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
- –ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ –∞—É–¥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π

---

## 6. MFA Deployment Diagram

**–§–∞–π–ª:** `mfa_deployment_diagram.puml`

### üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–û–ø–∏—Å—ã–≤–∞–µ—Ç —Ñ–∏–∑–∏—á–µ—Å–∫—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É —Å–∏—Å—Ç–µ–º—ã MFA, –ø–æ–∫–∞–∑—ã–≤–∞—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –Ω–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —É–∑–ª–∞—Ö –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã.

### üèóÔ∏è –£–∑–ª—ã —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è

#### 1. –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —Å—Ä–µ–¥–∞:
**–ú–æ–±–∏–ª—å–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (iOS/Android):**
- **TOTP Authenticator** - Google Authenticator, Authy –∏ –¥—Ä.

**–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–µ —Ä–∞–±–æ—á–∏–µ —Å—Ç–∞–Ω—Ü–∏–∏:**
- **S3 Client** - AWS CLI/SDK —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π MFA —Ç–æ–∫–µ–Ω–æ–≤

#### 2. –°–µ—Ä–≤–µ—Ä S3 Gateway:
**Go Runtime (Go 1.21+):**
- **Versity S3 Gateway** - –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å MFA
- **MFA Components** - MFA Service, Middleware, TOTP Generator, QR Generator

**–§–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞:**
- **MFA Data Store** - JSON —Ñ–∞–π–ª—ã —Å –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞ 0600
- **Configuration** - YAML/JSON –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

#### 3. –í–Ω–µ—à–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã:
- **IAM Backend** - LDAP/Vault/Database –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- **Logging System** - Syslog/ELK –¥–ª—è –∞—É–¥–∏—Ç–∞
- **Metrics System** - Prometheus/Grafana –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

### üîÑ –°–µ—Ç–µ–≤—ã–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
- **–ö–ª–∏–µ–Ω—Ç—ã ‚Üí Gateway:** HTTPS –∑–∞–ø—Ä–æ—Å—ã —Å MFA —Ç–æ–∫–µ–Ω–∞–º–∏ (–ø–æ—Ä—Ç 443/8080)
- **TOTP App ‚Üí QR Generator:** –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR –∫–æ–¥–æ–≤
- **Gateway ‚Üí IAM:** –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **Gateway ‚Üí Monitoring:** –õ–æ–≥–∏ –∏ –º–µ—Ç—Ä–∏–∫–∏

### üîí –ì—Ä–∞–Ω–∏—Ü—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- **DMZ:** –ü—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ HTTPS
- **Internal Network:** –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

### üìù –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- –§–∞–π–ª—ã —Å –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞ 0600
- –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ –ø–æ–∫–æ–µ
- –•–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ backup –∫–æ–¥—ã
- –ò–∑–æ–ª—è—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö

---

## 7. MFA Integration Diagram

**–§–∞–π–ª:** `mfa_integration_diagram.puml`

### üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –Ω–æ–≤–æ–π MFA —Å–∏—Å—Ç–µ–º—ã —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º S3 Gateway, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å.

### üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Å–ª–æ–∏

#### 1. –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Å–∏—Å—Ç–µ–º–∞:
- **S3 API Server** - –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π S3-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π API
- **V4 Authentication** - AWS V4 signature –≤–∞–ª–∏–¥–∞—Ü–∏—è
- **IAM Service** - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ —Ä–æ–ª—è–º–∏
- **S3 Controllers** - –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ S3 –æ–ø–µ—Ä–∞—Ü–∏–π
- **Storage Backend** - –•—Ä–∞–Ω–∏–ª–∏—â–µ –æ–±—ä–µ–∫—Ç–æ–≤

#### 2. –ù–æ–≤–∞—è MFA —Å–∏—Å—Ç–µ–º–∞:
- **MFA Service** - –û—Å–Ω–æ–≤–Ω–∞—è MFA —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- **MFA Middleware** - –°–ª–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ MFA
- **Enhanced Authentication** - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è V4 + MFA
- **MFA Storage** - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ MFA –¥–∞–Ω–Ω—ã–µ
- **MFA Admin API** - –ö–æ–Ω–µ—á–Ω—ã–µ —Ç–æ—á–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è MFA

#### 3. –°–ª–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:
- **Context Manager** - –û–±—â–∏–µ –∫–ª—é—á–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- **Policy Engine** - –û—Ü–µ–Ω–∫–∞ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π MFA
- **Audit Integration** - –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- **Metrics Integration** - –û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏

### üîÑ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
- **Enhanced Auth** –∑–∞–º–µ–Ω—è–µ—Ç V4 auth middleware
- **Enhanced Auth** –¥–µ–ª–µ–≥–∏—Ä—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é V4 –≤–∞–ª–∏–¥–∞—Ü–∏—é
- **Enhanced Auth** –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å MFA Middleware
- **Policy Engine** –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ IAM Service
- –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–µ—Ç—Ä–∏–∫–∏

### üìù –ö–ª—é—á–µ–≤—ã–µ —Ç–æ—á–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- –û–±–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π V4 –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–ª–æ—è MFA –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
- –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –ø–æ—Ç–æ–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

### üîí –ó–æ–Ω—ã —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
- **Backward Compatibility Zone:** V4 Auth, IAM Service, S3 Controllers
- **Enhanced Security Zone:** Enhanced Auth, MFA Middleware, MFA Service
- **Shared Infrastructure:** Context Manager, Audit Integration, Metrics

---

## 8. MFA Security Architecture

**–§–∞–π–ª:** `mfa_security_architecture.puml`

### üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–î–µ—Ç–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤—Å–µ —É—Ä–æ–≤–Ω–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ MFA —Å–∏—Å—Ç–µ–º—ã, –ø–æ–∫–∞–∑—ã–≤–∞—è –∑–∞—â–∏—Ç–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º.

### üèóÔ∏è –°–ª–æ–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

#### 1. –°–ª–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:
- **V4 Signature Validation** - –í–∞–ª–∏–¥–∞—Ü–∏—è V4 –ø–æ–¥–ø–∏—Å–µ–π
- **MFA Token Validation** - –í–∞–ª–∏–¥–∞—Ü–∏—è MFA —Ç–æ–∫–µ–Ω–æ–≤
- **Enhanced Authentication** - –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

#### 2. –û—Å–Ω–æ–≤–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å MFA:
- **TOTP Generator** - TOTP –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä
- **Secret Generator** - –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–µ–∫—Ä–µ—Ç–æ–≤
- **Backup Code Manager** - –ú–µ–Ω–µ–¥–∂–µ—Ä backup –∫–æ–¥–æ–≤
- **Lockout Manager** - –ú–µ–Ω–µ–¥–∂–µ—Ä –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

#### 3. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö:
- **Encrypted Storage** - –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
- **Hashed Backup Codes** - –•–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ backup –∫–æ–¥—ã
- **File Permissions** - –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º (0600)
- **Atomic Operations** - –ê—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

#### 4. –ü—Ä–∏–Ω—É–∂–¥–µ–Ω–∏–µ –ø–æ–ª–∏—Ç–∏–∫:
- **Role-based MFA** - MFA –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–æ–ª–µ–π
- **Operation-based MFA** - MFA –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–ø–µ—Ä–∞—Ü–∏–π
- **User Exemptions** - –ò—Å–∫–ª—é—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **Grace Periods** - –õ—å–≥–æ—Ç–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã

#### 5. –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∞—Ç–∞–∫:
- **Rate Limiting** - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏
- **User Lockout** - –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **Time Window Validation** - –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫–æ–Ω
- **Replay Attack Prevention** - –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ replay –∞—Ç–∞–∫

#### 6. –ê—É–¥–∏—Ç –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:
- **Security Logging** - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- **Failed Attempt Tracking** - –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
- **Success Metrics** - –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞
- **Alert Generation** - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ–ø–æ–≤–µ—â–µ–Ω–∏–π

### üåê –í–Ω–µ—à–Ω—è—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:
- **TOTP Apps** - TOTP –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (RFC 6238)
- **QR Code Security** - –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å QR –∫–æ–¥–æ–≤
- **Network Security** - –°–µ—Ç–µ–≤–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (HTTPS only)
- **IAM Integration** - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è IAM

### üìã –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º:
- **RFC 6238 TOTP** - Time-Based One-Time Password Algorithm
- **RFC 4226 HOTP** - HMAC-Based One-Time Password Algorithm
- **Crypto Standards** - crypto/rand –¥–ª—è —Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏
- **Security Best Practices** - –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è

### üìù –î–µ—Ç–∞–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

#### V4 Signature Security:
- HMAC-SHA256 –ø–æ–¥–ø–∏—Å—ã–≤–∞–Ω–∏–µ
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–∞
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫
- –í–∞–ª–∏–¥–∞—Ü–∏—è —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

#### TOTP Security Features:
- –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ RFC 6238
- 30-—Å–µ–∫—É–Ω–¥–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫–Ω–∞
- HMAC-SHA1 –∞–ª–≥–æ—Ä–∏—Ç–º
- Base32 –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤
- –î–æ–ø—É—Å–∫ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Å–¥–≤–∏–≥–∞ (¬±1 –æ–∫–Ω–æ)

#### Cryptographic Security:
- crypto/rand –¥–ª—è —Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏
- 160-–±–∏—Ç–Ω—ã–µ (20-–±–∞–π—Ç–Ω—ã–µ) —Å–µ–∫—Ä–µ—Ç—ã
- Base32 –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –¥–µ—Ä–∏–≤–∞—Ü–∏—è –∫–ª—é—á–µ–π

#### Data Protection:
- –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º 0600
- JSON —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è
- –ê—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∑–∞–ø–∏—Å–∏
- –ò–∑–æ–ª—è—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ backup –∫–æ–¥–æ–≤ (SHA256)

#### Abuse Prevention:
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
- –ü—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ —Ç–∞–π–º–∞—É—Ç—É
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º

#### Audit Trail:
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö MFA —Å–æ–±—ã—Ç–∏–π
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —É—Å–ø–µ—Ö–æ–≤/–Ω–µ—É–¥–∞—á
- –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ó–∞–ø–∏—Å—å –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫
- –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### üîí –ì—Ä–∞–Ω–∏—Ü—ã –¥–æ–≤–µ—Ä–∏—è
- **Trust Boundary:** Enhanced Auth, MFA Auth, Storage
- **External Trust:** TOTP Apps, IAM

---

## üéØ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–í—Å–µ PlantUML –¥–∏–∞–≥—Ä–∞–º–º—ã Task 2 –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—Ç –∫–æ–º–ø–ª–µ–∫—Å–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é —Å–∏—Å—Ç–µ–º—ã MFA, –æ—Ö–≤–∞—Ç—ã–≤–∞—é—â—É—é:

### üìä –£—Ä–æ–≤–Ω–∏ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏:
1. **–ö–æ–Ω—Ç–µ–∫—Å—Ç** - –í—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ
2. **–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã** - –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
3. **–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã** - –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
4. **–ö–æ–¥** - –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∫–ª–∞—Å—Å—ã –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã

### üîÑ –ü–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏–µ –∞—Å–ø–µ–∫—Ç—ã:
5. **–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
6. **–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ** - –§–∏–∑–∏—á–µ—Å–∫–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
7. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** - –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∏—Å—Ç–µ–º–æ–π
8. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### üîß –ö–ª—é—á–µ–≤—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:
- **–°—Ç–∞–Ω–¥–∞—Ä—Ç—ã:** RFC 6238, RFC 4226
- **–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:** Go, Fiber, JSON, YAML
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** crypto/rand, HMAC-SHA1, SHA256
- **–•—Ä–∞–Ω–µ–Ω–∏–µ:** –§–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å –ø—Ä–∞–≤–∞–º–∏ 0600
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:** V4 signature + MFA validation

–î–∞–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–æ–ª–Ω–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã MFA —Å–∏—Å—Ç–µ–º—ã –∏ —Å–ª—É–∂–∏—Ç –æ—Å–Ω–æ–≤–æ–π –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏, —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏.